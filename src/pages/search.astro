---
import OtherLayout from '@lay/OtherLayout.astro';
---
<OtherLayout title="Search" pagetitle="Search">
    <section aria-label="Search Results">
        <div class="py-0.5 bg-neutral-900">
            <div class="flex justify-between items-center mx-2">
                <p id="searchReadout" class="text-xs font-semibold text-white mt-1 cursor-default"></p>
            </div>
        </div>
        <div class="border-2 border-neutral-900 border-solid">
            <div class="px-3 pt-0.5 pb-2">
                <ul id="searchResults" class="flex flex-wrap items-center space-x-5 text-xs font-semibold mt-0.5"></ul>
            </div>
        </div>
    </section>
</OtherLayout>

<script>
    import DOMPurify from "dompurify";
    import Fuse from "fuse.js";
    import onlineusers from "../pages/api/users"; // Assuming this contains an array of user data

    // Constants and DOM Elements
    const FUSE_OPTIONS = {
        includeScore: true,
        shouldSort: true,
        threshold: 0.4,
        keys: ["name", "username"],
    };

    const SPINNER = `<div class="animate-spin inline-block size-8 border-[4px] border-current border-neutral-900 border-t-transparent rounded-full"></div>`;
    const searchval = document.getElementById("search") as HTMLInputElement | null;
    const searchReadout = document.querySelector("#searchReadout");
    const resultsList = document.querySelector("#searchResults");

    let SEARCH_DATA = onlineusers; // Load the users directly from the import
    let FUSE_INSTANCE = new Fuse(SEARCH_DATA, FUSE_OPTIONS); // Initialize Fuse with the user data

    // Functions
    function updateDocumentTitle(search) {
        document.title = search
            ? `Search results for "${search}" | Kinva`
            : "User Search | Kinva";
    }

    function updateSearchReadout(search) {
        searchReadout.textContent = search
            ? `Search results for "${search}"`
            : "Results for";
    }

    function updateSearchPageURL(search) {
        const url = new URL(window.location.href);
        url.searchParams.set("q", search);
        window.history.replaceState(null, "", url);
    }

    function generateSearchList(results) {
        return results
            .map(({ item }) => {
                const { name, username, profileimg } = item;
                return `
                    <li>
                        <a class="hover:text-red-600 hover:underline" href="/${username}" title="Visit ${name}'s profile">
                            <p class="text-xs flex justify-center font-semibold pb-0.5">${name}</p>
                            <img width="90" height="90" class="hover:no-underline" src="${profileimg || '/img/avatar.svg'}" alt="${name}'s profile picture" />
                        </a>
                    </li>`;
            })
            .join("");
    }

    function fetchSearchResults(search) {
        if (search.length === 0) {
            resultsList.innerHTML = "Enter a search term to find users.";
            return;
        }

        resultsList.innerHTML = SPINNER;

        // Perform the search
        const searchResult = FUSE_INSTANCE.search(search);

        // Update the results list
        resultsList.innerHTML =
            searchResult.length > 0
                ? generateSearchList(searchResult)
                : "No results foundâ€¦";
    }

    // Event Listeners
    window.addEventListener("DOMContentLoaded", () => {
        const urlParams = DOMPurify.sanitize(
            new URLSearchParams(window.location.search).get("q") || ""
        );

        fetchSearchResults(urlParams);
        updateDocumentTitle(urlParams);
        updateSearchReadout(urlParams);

        if (searchval) {
            searchval.value = urlParams;
            searchval.focus();
        }
    });

    if (searchval) {
        searchval.addEventListener("input", () => {
            const searchTerm = DOMPurify.sanitize(searchval.value);
            updateDocumentTitle(searchTerm);
            updateSearchReadout(searchTerm);
            fetchSearchResults(searchTerm);
            updateSearchPageURL(searchTerm);
        });
    }
</script>