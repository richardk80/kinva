---
import NonRegularBox from '@com/main/NonRegularBox.astro';

import AddFriendModal from '@com/main/AddFriendModal.astro';

import RemoveFriendModal from '@com/main/RemoveFriendModal.astro';

import CancelFriendRequestModal from '@com/main/CancelFriendRequestModal.astro';

import AddToFavoritesModal from '@com/main/AddToFavoritesModal.astro';

import { Icon } from 'astro-icon/components';

interface Props {
    loggedin?: boolean;
    myself?: boolean;
    name?: string;
    friendship?: boolean;
    requested?: boolean;
    addgroup?: boolean;
}

import users from '../../pages/api/users.json';

// Shuffle function
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Shuffle the users array
const shuffledUsers = shuffleArray(users);

const { username } = Astro.params;

console.log('Username from URL:', username);
console.log('Shuffled users array:', shuffledUsers);

const page = shuffledUsers.find(user => user.username === username);

console.log('Found page:', page);

if (!page) {
  return new Response('User not found', { status: 404 });
}

const { name, loggedin, myself, profilepic, profileimg, showlist, lastActive, friendship, requested, audiourl } = page;

//let parts = name.split(' ')
//let firstName = parts.shift();
//let lastName = parts.join(' ');
---
{ myself &&
<NonRegularBox
    name="Contacting" 
    username={name} 
    pclass="flex items-center ml-2 text-xs font-semibold text-white mt-0.5" 
    backgroundColor="bg-blue-400" 
    borderColor="border-blue-400"
>
    <div class="py-1.5 px-1">
        <div class="flex items-center justify-around">
            <div class="flex flex-col space-y-1.5">
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-2" href="/messages/send">
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name="envelope" />
                    <span class="group-hover:underline">Send Message</span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1 cursor-pointer" data-hs-overlay="#hs-friend-vertically-centered-modal" data-hs-overlay-keyboard="false">
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name={ friendship ? "user-minus" : ( requested ? "user-xmark" : "user-plus") } />
                    <span class="group-hover:underline">{ friendship ? "Remove Friend" : ( requested ? "Cancel Request" : "Add to Friends") }
                    </span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-2" href={`/${username}/bulletins`}>
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name="list" />
                    <span class="group-hover:underline">Read Bulletin</span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1.5 -ml-0.5" href="/">
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name="group-plus" />
                    <span class="group-hover:underline ml-0.5">Add to Group</span>
                </a>
            </div>
            <div class="flex flex-col space-y-1.5">
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1.5" href="/">
                    <Icon class="h-[15px] w-auto group-hover:no-underline" name="share" />
                    <span class="group-hover:underline">Forward to Friend</span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1 cursor-pointer" data-hs-overlay="#hs-favorites-vertically-centered-modal" data-hs-overlay-keyboard="false">
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name="circle-star" />
                    <span class="group-hover:underline">Add to Favorites</span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1" href="/">
                    <Icon class="h-[16px] w-auto group-hover:no-underline" name="ban" />
                    <span class="group-hover:underline">Block User</span>
                </a>
                <a class="flex items-start text-blue-600 fill-blue-600 font-semibold text-[11.2px] hover:text-red-600 hover:fill-red-600 w-fit group space-x-1.5" href="/">
                    <Icon class="h-[15px] w-auto group-hover:no-underline" name="flag" />
                    <span class="group-hover:underline">Report User</span>
                </a>
            </div>
        </div>
    </div>
    { requested ? <CancelFriendRequestModal /> : (friendship ? <RemoveFriendModal /> : <AddFriendModal />) }
    </NonRegularBox>
}

<AddFriendModal />

<CancelFriendRequestModal />

<RemoveFriendModal />

<AddToFavoritesModal />

<script>
    document.querySelectorAll('[data-hs-overlay]').forEach(trigger => {
    trigger.addEventListener('click', function () {
        const modalSelector = this.getAttribute('data-hs-overlay');
        const modal = document.querySelector(modalSelector);
        if (modal) {
            modal.classList.remove('hidden');
        }
    });
});

document.querySelectorAll('[data-hs-overlay="true"]').forEach(modal => {
    modal.addEventListener('click', function (event) {
        if (event.target === this) {
            this.classList.add('hidden');
        }
    });
});
</script>