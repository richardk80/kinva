---
import RandomPhotoBox from "@com/main/RandomPhotoBox.astro";

import { createClient } from 'pexels';

import { Icon } from 'astro-icon/components';

const queryterm = 'weather';

const API_KEY = import.meta.env.API_KEY;
const client = createClient(API_KEY);

const fetchRandomCuteAnimalPicture = async () => {
    try {
        const response = await client.photos.search({ query: `${queryterm}`, per_page: 100 });
        if (response && response['photos']) {
            const photos = response['photos'];
            if (Array.isArray(photos) && photos.length > 0) {
                const randomIndex = Math.floor(Math.random() * photos.length);
                return photos[randomIndex];
            }
        }
        console.error('No valid photos found in the response:', response);
    } catch (error) {
        console.error('Error fetching cute animal pictures:', error);
    }
    return null;
};

const dailyPicture = await fetchRandomCuteAnimalPicture();

const toTitleCase = (name) => {
    return name
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
};

let cleanedName = dailyPicture?.photographer?.replace(/photo by:\s*/i, "").trim();

const courtesyText = `
  <p>
    Courtesy of: <a href="${dailyPicture.photographer_url}" target="_blank">
      ${toTitleCase(cleanedName)}
    </a>
  </p>
`;
---

<RandomPhotoBox 
    widthcss="w-[304px]" 
    name={`${queryterm} Pictures`}
    loggedin
    pclass="flex items-center justify-between mx-2 text-white text-xs font-semibold mt-0.5 flex flex-grow capitalize" 
    backgroundColor="bg-blue-400" 
    borderColor="border-blue-400"
>
    <div class="m-2 h-[207px]">
        {dailyPicture ? (
            <div class="space-y-0.5 relative group">
                <div class="border-2 border-blue-400 relative overflow-hidden">
                    <!-- Link with data-lightbox attribute for Lightbox2 -->
                    <a href={dailyPicture.src.original} data-lightbox="cute-animals" data-title={courtesyText}>
                        <img class="h-[190px] w-full object-fill" src={dailyPicture.src.large} alt={dailyPicture.alt} loading="lazy" />
                        <!-- Hover overlay -->
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <Icon name="expand" class="fill-white opacity-90 h-10 w-10" />
                        </div>
                    </a>
                </div>
                <p class="flex justify-center text-xs">
                    Courtesy of: <a class="text-blue-600 hover:text-red-600 ml-1" href={dailyPicture.photographer_url} target="_blank">{toTitleCase(cleanedName)}</a>
                </p>
            </div>
        ) : (
            <p class="text-xs flex items-center justify-center pt-[90px]">Error fetching picture. Please try again later.</p>
        )}
    </div>
</RandomPhotoBox>
