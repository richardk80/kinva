---
import BubbleBox from "@com/main/BubbleBox.astro";

const queryterm = 'random';

import { createClient } from 'pexels';

// Use environment variable for security
const API_KEY = 'D3abfHpiBN6zZFpfBetWF4WdGfyLWKuJ1ORdwlcI2pgGI4V6pzN569dO'; // Ensure you've set this in your .env file
const client = createClient(API_KEY);

// Function to fetch a random picture of cute animals
const fetchRandomCuteAnimalPicture = async () => {
    try {
        const response = await client.photos.search({ query: `${queryterm}`, per_page: 100 });

        // Check if response contains photos
        if (response && response['photos']) {
            const photos = response['photos'];
            if (Array.isArray(photos) && photos.length > 0) {
                const randomIndex = Math.floor(Math.random() * photos.length);
                return photos[randomIndex]; // Return a randomly selected photo
            }
        }
        console.error('No valid photos found in the response:', response);
    } catch (error) {
        console.error('Error fetching cute animal pictures:', error);
    }
    return null; // Return null if there's an error
};

// Fetch a new picture every time the function is called
const dailyPicture = await fetchRandomCuteAnimalPicture();

// Function to format the photographer's name to title case
const toTitleCase = (name) => {
    return name
        .toLowerCase() // Convert to lowercase
        .split(' ') // Split by spaces
        .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize first letter of each word
        .join(' '); // Join back into a string
};
---
<BubbleBox 
    widthcss="w-[304px]" 
    name=`${queryterm} Pictures`
    loggedin
    pclass="flex items-center justify-between mx-2 text-white text-xs font-semibold mt-0.5 flex flex-grow capitalize" 
    backgroundColor="bg-blue-400" 
    borderColor="border-blue-400"
>
    <div class="m-2 h-[207px]">
        {dailyPicture ? (
            <div class="space-y-0.5">
                <div class="border-2 border-blue-400">
                    <img class="h-[190px] w-full object-fill" src={dailyPicture.src.large} alt={dailyPicture.alt} />
                </div>
                <h2 class="text-center text-xs">{toTitleCase(dailyPicture.photographer)}</h2>
            </div>
        ) : (
            <p class="text-xs flex items-center justify-center pt-[90px]">Error fetching picture. Please try again later.</p>
        )}
    </div>
</BubbleBox>